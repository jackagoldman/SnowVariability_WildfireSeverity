---
title: "ontario-wide-sem"
author: "Jack Goldman"
date: "2023-03-06"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/jgoldman/Work/PhD/forest-snow-fire-interactions/")

```

## Data analysis for structural equation Model

Load packages

```{r}
library(piecewiseSEM)
library(nlme)
library(tidyverse)
```

Source functions

```{r}
#indirect effects function (call ind.eff)
source("scripts/indirect-effects-function.R")

#total effects function (call tot.eff)
source("scripts/total-effects-function.R")

#vif function (call vif.lme)
source("scripts/vif-nlme-function.R")

#plot themes
source("scripts/plot_theme.R")

```


Read in data

```{r}
df_snow <- read.csv("Data/0-forest-snow-fire-data.csv") %>% 
  filter(Fire_Year < 2020 | Fire_Year <=2001) 

#where are nas
nas <-  df_snow %>% 
  select_if(function(x) any(is.na(x))) #ecoregion na's

#omit na's
new_data <- df_snow %>% select(-c(ecoregion)) %>% na.omit(.)

#make sure DC is greater than 0
new_data <- new_data %>% filter( dc > 0) 



```

RBR quant is negatively skewed. Fix this using square root
transformation for negatively skewed data

```{r}
#sqrt transform rbr quant
new_data <- new_data %>% mutate(rbr_qs = sqrt((max(RBR_quant+1)-RBR_quant)))
hist(new_data$rbr_qs)
```


Check the distribution of SDD and TSSM

```{r}
# check distribution SDD
hist(new_data$sdd)
qqnorm(new_data$sdd)

#TSSm
hist(new_data$tssm)
qqnorm(new_data$tssm)


```



*Notes:* Fit structural equation model - all fires: - I removed climate
data because DC takes into consideration ppt and temperature from the
first day of the fire season. - Should snow Accumulation day be included
because of Chelene's past work? Chelene found that Overwintering DC has
an effect, therefore the day that snow fell would determine
overwintering DC. -DC is correlated with time since snow melt because DC
is cumulative and would differ based on the amount of days between the
start of the fire season and fire burn, should theoretically increase as
TSSM increases - TSSM includes burn day, therefore ignition
probabilities are likely influenced by canopy closure, bioamass and age.
As biomass increases, ignition probability is higher, and as canopy
closure increases, ignition and spread is more ikely and as age
increases, more flammable fuel.



Test individual model pathways for multicollinearity using VIF function

```{r, Extreme burn severity}

#cc and avg biomass are highly correlated
vif.lme(lme(rbr_qs ~ dc + tssm + sdd +tri +age + 
    avgBio + cc, random = list(size_class =~1, Fire_Year =~1), data = new_data))

vif.lme(lme(tssm ~ sdd + tri , random = list(size_class =~1, Fire_Year =~1), data = new_data))

#cc and avg biomass are highly correlated
vif.lme(lme(sdd ~ cc + avgBio + age + tri , random = list(size_class =~1, Fire_Year =~1), data = new_data))

#compare models with cc or avgbio AIC 
rbr_bio <- lme(rbr_qs ~ dc + tssm + sdd +tri +age + 
    avgBio,random = list(size_class =~1, Fire_Year =~1), data = new_data)

rbr_cc <- lme(rbr_qs ~ dc + tssm + sdd +tri +age + 
    cc   , random = list(size_class =~1, Fire_Year =~1), data = new_data)
AIC(rbr_bio, rbr_cc) # CC is greater by .400 , I chose to use bio because it better predicts sdd

sdd_bio <- lme(sdd ~  avgBio + age + tri , random = list(size_class =~1, Fire_Year =~1), data = new_data)

sdd_cc <- lme(sdd ~  cc+ age + tri , random = list(size_class =~1, Fire_Year =~1), data = new_data)

AIC(sdd_bio, sdd_cc)# biomass has lower AIC

```



```{r, Median Burn Severity}
#cc and avg biomass are highly correlated
vif.lme(lme(RBR_median ~ dc + tssm + sdd +tri +age + 
    avgBio + cc, random = list(size_class =~1, Fire_Year =~1), data = new_data))

#compare models with cc or avgbio AIC 
mean_bio <- lme(RBR_median ~ dc + tssm + sdd +tri +age + 
    avgBio,random = list(size_class =~1, Fire_Year =~1), data = new_data)

mean_cc <- lme(RBR_median ~ dc + tssm + sdd +tri +age + 
    cc   , random = list(size_class =~1, Fire_Year =~1), data = new_data)
AIC(mean_bio, mean_cc) # CC is greater by 1.300 , I chose to use bio because it better predicts sdd

```

Look at each models residual vs. fitted plot
```{r}
plot(lme(rbr_qs ~ dc + tssm + sdd +tri +age + 
         avgBio, random = ~1 | Fire_Year/size_class, na.action = na.omit, data = new_data, method = "ML"))
plot(lme(tssm ~ sdd + tri, random = ~1 | Fire_Year/size_class, na.action = na.omit, data = new_data, method = "ML"))

plot(lme(sdd ~  avgBio + age + tri, random = ~1 | Fire_Year/size_class, na.action = na.omit, data = new_data, method = "ML"))

```



# All of Ontario

### Extreme

```{r, Extreme all of Ontario}
sem_ext <- psem(
  lme(rbr_qs ~ dc + tssm + sdd +tri +age + 
         avgBio, random = ~1 | Fire_Year/size_class, na.action = na.omit, data = new_data, method = "ML"),
  lme(tssm ~ sdd + tri, random = ~1 | Fire_Year/size_class, na.action = na.omit, data = new_data, method = "ML"),
  lme(sdd ~  avgBio + age + tri, random = ~1 | Fire_Year/size_class, na.action = na.omit, data = new_data, method = "ML")
)

#summary
summary(sem_ext)

```

There was an significant independence claim which was that drought code
has a significant impact on time since snowmelt. We refit the model to
include the pathway tssm \<- dc.

```{r, Extreme all of Ontario refit final model}
sem_ext_2 <- psem(
  lme(rbr_qs ~ dc + tssm + sdd +tri +age + 
        avgBio , random = ~1 | Fire_Year/size_class, na.action = na.omit, data = new_data, method = "ML"),
  lme(tssm ~ sdd + tri + dc + age + avgBio, random = ~1 | Fire_Year/size_class, na.action = na.omit, data = new_data, method = "ML"),
  lme(sdd ~  avgBio + age + tri, random = ~1 | Fire_Year/size_class, na.action = na.omit, data = new_data, method = "ML")
)

#summary
summary(sem_ext_2)

lapply(sem_ext_2, function(i) hist(resid(i))) # looks good

```

SDD did not have an impact on extreme burn severity - this suggests that
snowmelt timing does not influence burn severity, a possible explanation
for this is that snowmelt timing is heterogeneous across a landscape and
by averaging snowmelt timing and rbr across the perimeter we are
homogeneize both SDD and RBR, therefore we are unable to pick up
variations in both sdd/rbr. Further investigations that consider
variation in both. TSSM had a significant impact on extreme burn
severity - As time sine snowmelt increased, burn severity increased. DC
had a significant impact on extreme burn severity - As DC increased,
burn severity decreased. Forest structural diversity was a strong
predictor of extreme burn severity: - as age increased, burn severity
decreased - older stands decreased burn severity. - as biomass
increased, burn severity increased - overall biomass increased burn
severity. - as canopy closure increased burn severity decreased -
suggesting that live foliage biomass significantly reduces burn
severity, this may be a result of reduced flammability of live foliage.
SDD had a significant impact on time since snowmelt - as snowmelt got
later in the year, ignition date decreased. As DC increased, time since
snowmelt increased - this suggests that decreases in fuel moisture
significantly are a strong predictor of ignition and that ignitions were
more likely later in the year when drought code increased. SDD was
significantly influence by Biomass, age and topography; - as biomass
increased, SDD was earlier - as age increased, SDD was later - as
topography increased, sdd was earlier

Produce a clean summary table and write to csv - code from [@ramus2022]

```{r, Extreme All of Ontario Clean Summary Table}
modsum <- summary(sem_ext_2)$coefficients
modsum$Estimate <- round(modsum$Estimate, 3)
modsum$Std.Error <- round(modsum$Std.Error, 3)
modsum$Crit.Value <- round(modsum$Crit.Value, 3)
modsum$P.Value <- round(modsum$P.Value, 3)
modsum$P.Value <- ifelse(modsum$P.Value<0.001, "<0.001", modsum$P.Value)
modsum$Std.Estimate <- round(modsum$Std.Estimate, 3)
modsum$Response <- gsub("_", " ", modsum$Response)
modsum$Predictor <- gsub("_", " ", modsum$Predictor)
colnames(modsum)[4:8] <- c("SE", "DF", "t-Value", "P-Value", "Std. Estimate")
modsum

write.csv(modsum, "results/results-summary-tables/Table-1-sem-ext-ont.csv")
```

calculate indirect effects 

```{r}
ext_ont_ind_effects <- ind.eff(modsum, response = "extreme")

ext_ont_ind_effects
```


Calculate total effects
```{r}
ext_ont_total_effects <- tot.eff(modsum, response = "extreme")

ext_ont_total_effects
```



### Median burn severity for all of Ontario

```{r}
sem_med <- psem(
  lme(RBR_median ~ dc + tssm + sdd +tri +age + 
        avgBio, random = list(size_class =~1, Fire_Year =~1), na.action = na.omit, data = new_data, method = "ML"),
  lme(tssm ~ sdd + tri, random = list(size_class =~1, Fire_Year =~1), na.action = na.omit, data = new_data, method = "ML"),
  lme(sdd ~ avgBio + age + tri,random = list(size_class =~1, Fire_Year =~1), na.action = na.omit, data = new_data, method = "ML")
)


#summary
summary(sem_med)
```

Independence claim suggest significant impact of drought code on time
since snowmelt - update model to include pathway of tssm \<- dc

```{r}
sem_med_2 <- psem(
  lme(RBR_median ~ dc + tssm + sdd +tri +age + 
        avgBio, random = list(size_class =~1, Fire_Year =~1), na.action = na.omit, data = new_data, method = "ML"),
  lme(tssm ~ sdd + tri +dc + age + avgBio,random = list(size_class =~1, Fire_Year =~1), na.action = na.omit, data = new_data, method = "ML"),
  lme(sdd ~ avgBio + age + tri, random = list(size_class =~1, Fire_Year =~1), na.action = na.omit, data = new_data, method = "ML")
)


#summary
summary(sem_med_2)

lapply(sem_med_2, function(i) hist(resid(i))) # looks good

```

SDD has an effect on median burn severity , as snowmelt increased median
burn severity decreased. - the difference between this and extreme is
consistent with the literature that suggests that more extreme fire
events are caused by extreme fire weather and when fire weather is
extreme it minimizes or negates the impact of other drivers. I.e.
extreme fire weather is more powerful and overcomes in the importance of
other drivers. Therefore it is expected that extreme severity events
occur under extreme fire conditions making snowmelt timing impact
negligible.

Clean summary table - code from [@ramus2022]

```{r}
modsum_med_all <- summary(sem_med_2)$coefficients
modsum_med_all$Estimate <- round(modsum_med_all$Estimate, 3)
modsum_med_all$Std.Error <- round(modsum_med_all$Std.Error, 3)
modsum_med_all$Crit.Value <- round(modsum_med_all$Crit.Value, 3)
modsum_med_all$P.Value <- round(modsum_med_all$P.Value, 3)
modsum_med_all$P.Value <- ifelse(modsum_med_all$P.Value<0.001, "<0.001", modsum_med_all$P.Value)
modsum_med_all$Std.Estimate <- round(modsum_med_all$Std.Estimate, 3)
modsum_med_all$Response <- gsub("_", " ", modsum_med_all$Response)
modsum_med_all$Predictor <- gsub("_", " ", modsum_med_all$Predictor)
colnames(modsum_med_all)[4:8] <- c("SE", "DF", "t-Value", "P-Value", "Std. Estimate")
modsum_med_all

write.csv(modsum_med_all, "results/results-summary-tables/Table-2-sem-med-ont.csv")
```


```{r}

med_ont_ind_effects <- ind.eff(modsum_med_all, response = "median")

med_ont_ind_effects 

```

```{r}
med_ont_tot_effects <- tot.eff(modsum_med_all, response = "median")

med_ont_tot_effects
```
It seems that the signs flipped between total indirect effects and total effects in this equation
check to see if it makes sense

plot the indirect effects of forest structure on burn severity
```{r}
med_ont_ind_eff_sf <- med_ont_ind_effects %>% 
  filter(Mediator == "snow free date") %>% 
  mutate(`Snow Free Date` = rep("Snow Free Date"))
med_ont_ind_eff_sfd <- med_ont_ind_effects %>% 
  filter( Mediator == "snow free duration")%>% 
  mutate(`Snow Free Duration` = rep("Snow Free Duration"))
med_ont_tot_effects <- med_ont_tot_effects %>% 
  rename(tot_ind_eff = "Total Indirect Effect") %>% 
  rename(tot_eff ="Total Effect") %>% 
  mutate(`Total Indirect Effect` = rep("Total Indirect Effect"),
                                     `Total Effect`= rep("Total Effect"))

 ggplot()+
  geom_point(data = med_ont_ind_eff_sf, aes(x = `Indirect Effect`, y = Pathway, color = "Snow Free Date"), size = 5) +
  geom_point(data = med_ont_ind_eff_sfd, aes(x = `Indirect Effect`, y = Pathway, color = "Snow Free Duration"), size = 5) +
  geom_point(data = med_ont_tot_effects, aes(x = tot_ind_eff, y = Pathway, color = "Total Indirect Effect"), size = 5)+ 
  geom_point(data = med_ont_tot_effects, aes(x= tot_eff, y = Pathway, color = "Total Effect"), size =5) + 
  theme_bw()+
  theme(axis.title = element_text(size = 14, family = "Helvetica"), 
        axis.text = element_text(size = 10, family = "Helvetica"),
    panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, linewidth=1)) + 
  theme(legend.position = c(0.8, 0.87))




```

